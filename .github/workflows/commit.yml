name: Safe Aggressive Commits

# Обязательно даём права на запись
permissions:
  contents: write

on:
  workflow_dispatch:          # запуск по кнопке

jobs:
  commit-burst:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Your Name"
          git config --global user.email "yourname@users.noreply.github.com"

      - name: Burst commits (controlled speed)
        run: |
          # --------------------- НАСТРОЙКИ ---------------------
          TARGET=1000                   # сколько коммитов хотим за запуск
          COMMITS_PER_PUSH=10           # сколько коммитов в одном git push
          SLEEP_BETWEEN_PUSHES=6        # пауза в секундах между push (6 сек ≈ 600 коммитов/час)
          # ------------------------------------------------------

          total=0
          start=$(date +%s)

          while [ $total -lt $TARGET ]; do
            remaining=$((TARGET - total))
            batch=$(( COMMITS_PER_PUSH < remaining ? COMMITS_PER_PUSH : remaining ))

            for ((i=1; i<=batch; i++)); do
              ts=$(date '+%Y-%m-%d %H:%M:%S.%3N')
              echo "$ts commit $((total + i))" >> commits.log
            done

            git add .
            git commit -m "burst $(date '+%H:%M:%S')" --allow-empty || true

            git push origin HEAD || {
              echo "Push failed, waiting extra..."
              sleep 30
              git push origin HEAD || exit 1
            }

            total=$((total + batch))
            now=$(date +%s)
            elapsed=$((now - start))
            echo "Progress: $total / $TARGET | ~$((elapsed / 60)) min"

            sleep $SLEEP_BETWEEN_PUSHES
          done

          echo "Completed. Total: $total commits"
          echo "Time taken: $(( (now - start) / 60 )) minutes"
